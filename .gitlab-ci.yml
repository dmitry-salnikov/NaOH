types:
  - test
  - package

before_script: 
    - if ! which git; then apt-get update && apt-get install git --no-install-recommends -y; fi
    - git submodule update --init --recursive

variables:

testMac:
  type: test
  script:
    - killall -9 com.apple.CoreSimulator.CoreSimulatorService; killall Simulator; true
    - DEVELOPER_DIR=/Applications/Xcode7.app/ instruments -w 'Select a iOS Simulator UUID' || true
    - sleep 10
    - atpm fetch
    - DEVELOPER_DIR=/Applications/Xcode7.app/Contents/Developer xcodebuild -scheme NaOH clean test
  tags:
    - xcode7symlink
    - atpm

testiOSSim64Swift22:
  type: test
  script:
    - atpm fetch
    - killall -9 com.apple.CoreSimulator.CoreSimulatorService; killall Simulator; true
    - DEVELOPER_DIR=/Applications/Xcode7.app/ instruments -w 'Select a iOS Simulator UUID' || true
    - sleep 10
    - DEVELOPER_DIR=/Applications/Xcode7.app/Contents/Developer xcodebuild -scheme NaOHiOSTestHostApp -configuration Debug -destination "platform=iOS Simulator,name=iPhone 6" clean test
  tags:
    - xcode7symlink
    - atpm

testiOSSim64Swift23:
  type: test
  script:
    - atpm fetch
    - killall -9 com.apple.CoreSimulator.CoreSimulatorService; killall Simulator; true
    - cp -R external/Caroline/channels/core-ios-swift-2.3/bin/CarolineCore.framework external/Caroline/channels/core-ios-swift-2.2/bin
    - DEVELOPER_DIR=/Applications/Xcode8.app/Contents/Developer TOOLCHAINS=com.apple.dt.toolchain.Swift_2_3 xcodebuild -scheme NaOHiOSTestHostApp -configuration Debug -destination "platform=iOS Simulator,name=iPhone 6" clean test
  tags:
    - xcode8symlink 
    - atpm

iosSwift22DeviceTest:
  type: test
  script:
    - atpm fetch
    - DEVELOPER_DIR=/Applications/Xcode7.app/ instruments -w 'Select a iOS Simulator UUID' || true
    - sleep 10
    - DEVELOPER_DIR=/Applications/Xcode7.app/Contents/Developer xcodebuild -scheme NaOHiOSTestHostApp -configuration Debug -destination "platform=iOS,name=DCA" clean test
  tags:
    - xcode7symlink
    - iosDevice
    - atpm

iosSwift23DeviceTest:
  type: test
  script:
    - atpm fetch
    - cp -R external/Caroline/channels/core-ios-swift-2.3/bin/CarolineCore.framework external/Caroline/channels/core-ios-swift-2.2/bin
    - DEVELOPER_DIR=/Applications/Xcode8.app/Contents/Developer TOOLCHAINS=com.apple.dt.toolchain.Swift_2_3 xcodebuild -scheme NaOHiOSTestHostApp -configuration Debug -destination "platform=iOS,name=DCA" clean test
  tags:
    - xcode8symlink
    - iosDevice
    - atpm

archiveiOS:
   type: package
   script:
      - killall -9 com.apple.CoreSimulator.CoreSimulatorService; killall Simulator; true
      - DEVELOPER_DIR=/Applications/Xcode7.app/ instruments -w 'Select a iOS Simulator UUID' || true
      - sleep 10
      - DEVELOPER_DIR=/Applications/Xcode7.app/Contents/Developer carthage build --no-skip-current --platform ios
      - mkdir binaries
      - cp -R Carthage/Build/iOS/* binaries/
      - strip -S -x binaries/NaOH.framework/NaOH
      - plutil -replace CFBundleVersion -string "$CI_BUILD_ID" binaries/NaOH.framework/Info.plist
   tags:
    - xcode7symlink

   artifacts:
      paths:
      - binaries/
      name: "NaOH-iOS-${CI_BUILD_REF_NAME}-${CI_BUILD_ID}"

archiveiOS23:
   type: package
   script:
      - killall -9 com.apple.CoreSimulator.CoreSimulatorService; killall Simulator; true
      - DEVELOPER_DIR=/Applications/Xcode8.app/Contents/Developer TOOLCHAINS=com.apple.dt.toolchain.Swift_2_3 carthage build --no-skip-current --platform ios
      - mkdir binaries
      - cp -R Carthage/Build/iOS/* binaries/
      - strip -S -x binaries/NaOH.framework/NaOH
      - plutil -replace CFBundleVersion -string "$CI_BUILD_ID" binaries/NaOH.framework/Info.plist
   tags:
    - xcode8symlink

   artifacts:
      paths:
      - binaries/
      name: "NaOH-iOS-${CI_BUILD_REF_NAME}-${CI_BUILD_ID}"


archiveMac:
   type: package
   script:
      - killall -9 com.apple.CoreSimulator.CoreSimulatorService; killall Simulator; true
      - xcrun instruments -w 'Select a iOS Simulator UUID' || true
      - sleep 10
      - "DEVELOPER_DIR=/Applications/Xcode7.app/Contents/Developer carthage build --no-skip-current --platform osx"
      - mkdir binaries
      - cp -R Carthage/Build/Mac/* binaries/
      - strip -S -x binaries/NaOH.framework/NaOH 
      - plutil -replace CFBundleVersion -string "$CI_BUILD_ID" binaries/NaOH.framework/Versions/A/Resources/Info.plist

   artifacts:
      paths:
      - binaries
      name: "NaOH-OSX-${CI_BUILD_REF_NAME}-${CI_BUILD_ID}"

   tags:
    - xcode7symlink
