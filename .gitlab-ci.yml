types:
  - test
  - package

before_script: 
    - if ! which git; then apt-get update && apt-get install git --no-install-recommends -y; fi
    - git submodule update --init --recursive

variables:

testMac:
  type: test
  script:
    - atpm fetch
    - xcodebuild -scheme NaOH clean test
  tags:
    - xc7
    - atpm

testiOSSim64:
  type: test
  script:
    - atpm fetch
    - xcodebuild -scheme NaOHiOSTestHostApp -configuration Debug -destination "platform=iOS Simulator,name=iPhone 6" clean test
  tags:
    - xc7
    - atpm

testiOSSim64:
  type: test
  script:
    - atpm fetch
    - xcodebuild -scheme NaOHiOSTestHostApp -configuration Debug -destination "platform=iOS Simulator,name=iPhone 4s" clean test
  tags:
    - xc7
    - atpm

iosDeviceTest:
  type: test
  script:
    - atpm fetch
    - xcodebuild -scheme NaOHiOSTestHostApp -configuration Debug -destination "platform=iOS,name=Dca's iPod touch" clean test
  tags:
    - xc7
    - iosDevice
    - atpm

archiveiOS:
   type: package
   script:
      - carthage build --no-skip-current --platform ios
      - mkdir binaries
      - cp -R Carthage/Build/iOS/* binaries/
      - strip -S -x binaries/NaOH.framework/NaOH
      - plutil -replace CFBundleVersion -string "$CI_BUILD_ID" binaries/NaOH.framework/Info.plist
   tags:
    - xc7

   artifacts:
      paths:
      - binaries/
      name: "NaOH-iOS-${CI_BUILD_REF_NAME}-${CI_BUILD_ID}"


archiveMac:
   type: package
   script:
      - "carthage build --no-skip-current --platform osx"
      - mkdir binaries
      - cp -R Carthage/Build/Mac/* binaries/
      - strip -S -x binaries/NaOH.framework/NaOH 
      - plutil -replace CFBundleVersion -string "$CI_BUILD_ID" binaries/NaOH.framework/Versions/A/Resources/Info.plist

   artifacts:
      paths:
      - binaries
      name: "NaOH-OSX-${CI_BUILD_REF_NAME}-${CI_BUILD_ID}"

   tags:
    - xc7

atbuildMac:
  type: test
  script:
    - atpm fetch
    - atbuild check

  tags:
    - osx
    - atbuild
    - openswift
    - atpm

  artifacts:
    paths:
      - bin/NaOH.a
      - bin/NaOH.swiftmodule

linux:
  type: test
  script:
        - apt-get update && apt-get install --no-install-recommends xz-utils curl git ca-certificates atpm atbuild caroline-static-tool -y
        - atpm fetch
        - atbuild check
        
  image: drewcrawford/buildbase:latest

  tags:
  - autoscale-linux
